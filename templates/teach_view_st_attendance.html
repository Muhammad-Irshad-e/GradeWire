{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>View Student Attendance</title>
    <link rel="stylesheet" type="text/css" href="{% static 'assets/css/teach-style.css' %}">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .loading {
            display: none;
            color: blue;
            font-weight: bold;
        }
        .main-content {
            position: relative;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            cursor: pointer;
            color: #fff;
            background-color: #1e90ff;
            border:none;
            border-radius: 3px;
        }
    
        .back-button:hover {
            background-color: #0c60b5;
        }

    .section{
      margin-top: 35px;
    }
    </style>
</head>
<body>
    <div class="menu-toggle" onclick="toggleSidebar()">â˜° Menu</div>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Teacher Dashboard</h2>
        <a href="{% url 'teachHome' %}">Home</a>
        <a href="{% url 'teacherProfile' %}">Profile</a>
        <a href="{% url 'teachStAttendance' %}">Attendance</a>
        <a href="{% url 'view_student_attendance' %}">View Attendance</a>
        <a href="{% url 'teachStMarks' %}">Marks</a>
        <a href="{% url 'view_student_marks' %}">View Marks</a>
        <a href="{% url 'teachStStats' %}">Stats</a>
        <a href="{% url 'StudentDetail' %}">Students</a>
        <a href="{% url 'logout' %}" class="logout" id="logoutButton">Logout</a>
    </div>

    <div class="main-content">
        <button class="back-button" onclick="history.back()">Back</button>    <!-- admin Login Page -->

        <div id="attendance" class="section">
            <h2>View Student Attendance</h2>
            <form id="attendanceFilterForm">
                <label for="department">Department:</label>
                <select name="department" id="department" required>
                    <option value="">Select Department</option>
                    {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="semester">Semester:</label>
                <select name="semester" id="semester" required>
                    <option value="">Select Semester</option>
                    {% for semester_value, semester_label in semesters %}
                        <option value="{{ semester_value }}">{{ semester_label }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="subject">Subject:</label>
                <select name="subject" id="subject" required>
                    <option value="">Select Subject</option>
                </select><br><br>

                <button type="button" id="filterButton">Filter Attendance</button>
                <span class="loading" id="loadingIndicator">Loading...</span>
            </form>

            <div id="totalAttendanceMarked" style="margin-top: 20px; font-weight: bold;"></div>
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Class</th>
                        <th>Total Hours Present</th>
                        <th>Attendance Percentage</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <!-- Attendance data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
document.getElementById('department').addEventListener('change', updateSubjects);
document.getElementById('semester').addEventListener('change', updateSubjects);

function updateSubjects() {
    const department = document.getElementById('department').value;
    const semester = document.getElementById('semester').value;
    const subjectSelect = document.getElementById('subject');

    subjectSelect.innerHTML = '<option value="">Select Subject</option>'; // Reset dropdown

    if (department && semester) {
        fetch(`/get_filtered_subjects/?department=${encodeURIComponent(department)}&semester=${encodeURIComponent(semester)}`)
            .then(response => response.json())
            .then(data => {
                if (data.subjects.length === 0) {
                    alert('No subjects found for the selected department and semester.');
                    return;
                }
                data.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = `${subject.name} (${subject.subject_code})`;
                    subjectSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching subjects:', error);
                alert('An error occurred while fetching subjects.');
            });
    }
}

document.getElementById('filterButton').addEventListener('click', function() {
    const department = document.getElementById('department').value;
    const semester = document.getElementById('semester').value;
    const subject = document.getElementById('subject').value;
    const loadingIndicator = document.getElementById('loadingIndicator');
    const attendanceTableBody = document.getElementById('attendanceTableBody');
    const totalAttendanceDiv = document.getElementById('totalAttendanceMarked');

    if (!department || !semester || !subject) {
        alert('Please select all filters.');
        return;
    }

    loadingIndicator.style.display = 'inline';
    attendanceTableBody.innerHTML = ''; // Clear table
    totalAttendanceDiv.innerHTML = ''; // Clear previous total

    fetch(`/fetch_attendance_data/?department=${encodeURIComponent(department)}&semester=${encodeURIComponent(semester)}&subject=${encodeURIComponent(subject)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            if (data.attendance_data.length === 0) {
                attendanceTableBody.innerHTML = '<tr><td colspan="4">No attendance records found.</td></tr>';
                totalAttendanceDiv.innerHTML = 'Total Sessions Marked: 0';
                return;
            }

            // Display total sessions marked (basis for 100% attendance)
            totalAttendanceDiv.innerHTML = `Total Sessions Marked: ${data.total_attendance_marked}`;

            data.attendance_data.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.student_name}</td>
                    <td>${student.class}</td>
                    <td>${student.total_hours_present}</td>
                    <td>${student.attendance_percentage}%</td>
                `;
                attendanceTableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error fetching attendance data:', error);
            alert('An error occurred. Please try again later.');
        })
        .finally(() => {
            loadingIndicator.style.display = 'none';
        });
});

function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('active');
}
    </script>
</body>
</html>